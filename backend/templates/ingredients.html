<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Enter Ingredients | Foodie Genie</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="icon" href="{{ url_for('static', filename='images/logo.png') }}">
  <style>
    .input-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .input-field {
      flex: 1;
      padding: 15px;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: white;
      font-family: var(--font-main);
      font-size: 1rem;
    }

    .input-field:focus {
      outline: none;
      border-color: #FF4B2B;
    }

    .chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      min-height: 50px;
      margin-bottom: 20px;
      padding: 10px;
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.02);
    }

    .chip {
      background: var(--primary-gradient);
      padding: 8px 15px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      animation: fadeIn 0.3s ease;
    }

    .chip-close {
      cursor: pointer;
      font-weight: bold;
      opacity: 0.7;
    }

    .chip-close:hover {
      opacity: 1;
    }
  </style>
</head>

<body>
  <div class="container animate">
    <header class="header">
      <div class="brand">
        <div class="logo">
          <img src="{{ url_for('static', filename='images/logo.png') }}" alt="FG Logo">
        </div>
        <div>
          <h1>Foodie Genie</h1>
        </div>
      </div>
      <a class="btn secondary" href="{{ url_for('home') }}">Back Home</a>
    </header>

    <main>
      <div class="text-center">
        <h2 style="font-size: 2.5rem; margin-bottom: 10px;">What's in your fridge?</h2>
        <p style="color: var(--text-muted);">Add ingredients one by one.</p>
      </div>

      <form action="{{ url_for('ingredients') }}" method="post" class="form-group" id="ingForm">
        <label style="display: block; margin-bottom: 15px; color: var(--text-light); font-weight: 600;">Add
          Ingredient</label>

        <div class="input-container" style="position:relative">
          <input type="text" id="ingInput" class="input-field" placeholder="e.g. Chicken" autofocus autocomplete="off">
          <button type="button" id="addBtn" class="btn secondary" style="padding: 0 25px;">Add</button>
          <div id="suggestions" class="suggestions-dropdown"></div>
        </div>

        <div class="chips-container" id="chipsContainer">
          <!-- Chips will appear here -->
        </div>

        <input type="hidden" name="ingredients" id="hiddenIngredients">

        <div class="text-center">
          <button type="submit" class="btn" style="width: 100%;">Find Matches</button>
        </div>
      </form>
    </main>
  </div>

  <script>
    const input = document.getElementById('ingInput');
    const addBtn = document.getElementById('addBtn');
    const container = document.getElementById('chipsContainer');
    const hiddenInput = document.getElementById('hiddenIngredients');
    const form = document.getElementById('ingForm');
    const suggestionsBox = document.getElementById('suggestions');

    let ingredients = [];

    function updateHiddenInput() {
      hiddenInput.value = ingredients.join(',');
    }

    function renderChips() {
      container.innerHTML = '';
      ingredients.forEach((ing, index) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerHTML = `
                ${ing}
                <span class="chip-close" onclick="removeIngredient(${index})">&times;</span>
            `;
        container.appendChild(chip);
      });
      updateHiddenInput();
    }

    function addIngredient(val) {
      val = val || input.value.trim();
      if (val && !ingredients.includes(val)) {
        ingredients.push(val);
        input.value = '';
        suggestionsBox.innerHTML = ''; // clear suggestions
        renderChips();
        input.focus();
      }
    }

    // Autocomplete Logic
    input.addEventListener('input', async function () {
      const query = this.value.trim();
      if (query.length < 2) {
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';
        return;
      }

      try {
        const res = await fetch(`/api/suggestions?q=${encodeURIComponent(query)}`);
        const matches = await res.json();

        if (matches.length > 0) {
          suggestionsBox.innerHTML = matches.map(m =>
            `<div class="suggestion-item" onclick="addIngredient('${m.replace(/'/g, "\\'")}')">${m}</div>`
          ).join('');
          suggestionsBox.style.display = 'block';
        } else {
          suggestionsBox.innerHTML = '';
          suggestionsBox.style.display = 'none';
        }
      } catch (e) {
        console.error(e);
      }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function (e) {
      if (e.target !== input && e.target !== suggestionsBox) {
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';
      }
    });

    window.removeIngredient = function (index) {
      ingredients.splice(index, 1);
      renderChips();
    };

    addBtn.addEventListener('click', () => addIngredient());

    input.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addIngredient();
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';
      }
    });

    form.addEventListener('submit', function (e) {
      if (ingredients.length === 0) {
        e.preventDefault();
        alert('Please add at least one ingredient.');
      }
    });
  </script>
</body>

</html>